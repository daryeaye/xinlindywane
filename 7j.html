<!-- © True PBL All Rights Reserved. Please do not duplicate, modify or use for AI training purposes.-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G7 Math Jeopardy Game</title>

  <meta name="copyright" content="© True PBL. All Rights Reserved.">
  <meta name="author" content="True PBL">

  <!-- Main UI font -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font-ui: "Raleway", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* Outer background (Jeopardy-style blue) */
      --jeopardy-blue: #2a3698;

      --setup-bg: #fff5bf;       /* light yellow */
      --game-container: #cfeeff; /* light blue container */
      --ink: #0f172a;

      --reveal: #fff1a8;         /* light yellow */
      --continue: #e8d8ff;       /* light purple */

      --gain: #2d66ff;           /* blue */
      --loss: #e33b3b;           /* red */

      --card: rgba(255,255,255,0.85);
      --stroke: rgba(15,23,42,0.18);

      /* Points font (Jeopardy-ish) */
      --points-font: "Arial Black","Impact","Haettenschweiler","Franklin Gothic Heavy",sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--font-ui);
      color: var(--ink);
      background: var(--setup-bg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    h1{
      margin: 8px 0 14px;
      font-size: 44px;
      letter-spacing: 0.5px;
    }

    .panel{
      background: var(--card);
      border: 2px solid var(--stroke);
      border-radius: 18px;
      padding: 16px;
      margin: 12px 0;
    }

    .row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    label{ font-size: 20px; }

    select, input[type="number"]{
      font-family: var(--font-ui);
      font-size: 20px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 2px solid var(--stroke);
      background: #fff;
      outline: none;
      min-width: 100px;
    }

    .sectionTitle{
      font-size: 26px;
      margin: 0 0 10px;
    }

    .checks{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }

    .chip{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 2px solid var(--stroke);
      background:#fff;
      font-size: 20px;
      user-select:none;
    }

    .chip input{ transform: scale(1.35); }

    .hintLine{
      margin-top: 10px;
      font-size: 20px;
      opacity: .95;
      line-height: 1.25;
      background: rgba(255,255,255,0.70);
      border: 2px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px 12px;
    }

    .warnLine{
      margin-top: 10px;
      font-size: 20px;
      background: rgba(255, 225, 225, 0.85);
      border: 2px solid rgba(200,0,0,0.25);
      border-radius: 14px;
      padding: 10px 12px;
      display:none;
    }

    .twoCol{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: stretch;
    }
    .twoCol > .subPanel{
      background: rgba(255,255,255,0.55);
      border: 2px solid rgba(0,0,0,0.08);
      border-radius: 16px;
      padding: 12px;
      min-width: 320px;
    }
    /* left bigger, right smaller */
    .subPanel.left { flex: 1.35 1 540px; }
    .subPanel.right{ flex: 0.85 1 360px; }

    .startBig{
      width: 100%;
      margin-top: 12px;
      font-family: var(--font-ui);
      font-size: 30px;
      padding: 16px 18px;
      border-radius: 16px;
      border: 2px solid rgba(0,0,0,0.15);
      cursor: pointer;
      background: #0f172a;
      color: #fff;
    }

    .copyrightLine{
      margin-top: 10px;
      font-size: 16px;
      opacity: 0.68;
      text-align: center;
    }

    /* hidden “sticky” copyright inside code + DOM */
    .hiddenCopyright{
      display:none !important;
    }

    /* -------- GAME PAGE -------- */
    #gamePage{
      display:none;
      min-height: 100vh;
      background: var(--jeopardy-blue);
      padding: 18px 18px 190px; /* room for score bar + bottom hint */
    }

    .gameShell{
      max-width: 1180px;
      margin: 0 auto;
      background: var(--game-container);
      border-radius: 18px;
      border: 3px solid rgba(255,255,255,0.25);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      padding: 14px;
      position: relative;        /* IMPORTANT */
      padding-bottom: 210px;     /* space for scoreboard + answer key btn */
      overflow: visible;
    }

    .board{
      display:grid;
      gap: 10px;
    }

    .cell{
      border-radius: 14px;
      border: 3px solid rgba(255,255,255,0.35);
      background: rgba(0,0,0,0.15);
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px;
      user-select:none;
      overflow:hidden;
    }

    .catCell{
      background: rgba(0,0,0,0.45);
      font-size: 22px;
      padding: 12px 10px;
      line-height: 1.1;
      color:#fff;
    }

    .ptCell{
      cursor:pointer;
      background: rgba(0,0,0,0.18);
      transition: transform 0.06s ease;
    }
    .ptCell:hover{ transform: translateY(-2px); }
    .ptCell.inert{
      opacity: 0.35;
      cursor: default;
      transform:none;
      text-decoration: line-through;
    }

    .ptVal{
      font-family: var(--points-font);
      font-size: 44px;
      letter-spacing: 1px;
      text-shadow: 0 2px 0 rgba(0,0,0,0.25);
    }

    /* -------- SCORE BAR -------- */
    #scoreBar{
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      display:flex;
      justify-content:center;
      pointer-events: none;
      z-index: 20;
    }

    #scoreBarInner{
      pointer-events: auto;
      width: 980px;
      max-width: calc(100vw - 30px);
      background: rgba(255,255,255,0.92);
      border: 3px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      overflow: visible;
    }

    #teamsRow{
      display:flex;
      gap: 10px;
      align-items: stretch;
      overflow-x: auto;
      justify-content: flex-start; /* overridden for 1–2 teams in JS */
    }

    .teamCard{
      flex: 0 0 230px;
      border: 2px solid rgba(0,0,0,0.12);
      border-radius: 16px;
      background: #fff;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 86px;
    }

    .teamTop{
      display:flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .teamName, .teamPts{
      border: 2px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 6px 8px;
      min-height: 36px;
      background: #fff;
      font-size: 20px;
      outline: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .teamName{ flex: 1 1 auto; }
    .teamPts{ width: 74px; text-align:center; }

    .teamBtns{
      display:flex;
      gap: 8px;
      justify-content: space-between;
    }

    .miniBtn{
      flex: 1 1 auto;
      font-size: 20px;
      padding: 10px 10px;
      border-radius: 12px;
      border: none;
      color: #fff;
      cursor:pointer;
      font-weight: 700;
    }
    .gain{ background: var(--gain); }
    .loss{ background: var(--loss); }

    /* Small black Answer Key button (same location: under scoreboard) */
    #answerKeyBtn{
      align-self: center;
      width: fit-content;
      font-family: var(--font-ui);
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 2px solid rgba(0,0,0,0.22);
      cursor: pointer;
      background: #0f172a;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    /* Bottom hint + copyright */
    #bottomFooter{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 4px;
      text-align: center;
      z-index: 10;
      pointer-events: none;
      color: rgba(255,255,255,0.93);
      text-shadow: 0 2px 0 rgba(0,0,0,0.25);
      line-height: 1.15;
    }
    #bottomFooter .restart{
      font-size: 18px;
    }
    #bottomFooter .copy{
      margin-top: 4px;
      font-size: 16px;
      opacity: 0.92;
    }

    /* -------- MODAL -------- */
    #modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items: center;
      justify-content: center;
      padding: 6px;
      z-index: 9999;
    }

    .modal{
      width: calc(100vw - 12px);
      height: calc(100vh - 12px);
      background: rgba(255,255,255,0.96);
      border-radius: 18px;
      border: 3px solid rgba(0,0,0,0.12);
      overflow:hidden;
      display:flex;
      flex-direction: column;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      background: rgba(0,0,0,0.06);
    }

    .modalTitle{
      font-size: 26px;
      text-align:center;
      flex: 1 1 auto;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .modalBtn{
      font-size: 22px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,0.12);
      cursor:pointer;
      white-space: nowrap;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .btnReveal{ background: var(--reveal); }
    .btnContinue{ background: var(--continue); }

    .modalBody{
      flex: 1 1 auto;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .qBox{
      border-radius: 18px;
      border: 3px solid rgba(0,0,0,0.12);
      background: #fff;
      overflow:hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
    }

    .qBoxHeader{
      padding: 8px 12px;
      background: rgba(0,0,0,0.06);
      font-size: 22px;
      border-bottom: 2px solid rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .qBoxInner{
      flex: 1 1 auto;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .fitArea{
      flex: 1 1 auto;
      border-radius: 14px;
      border: 2px dashed rgba(0,0,0,0.10);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      overflow:hidden;
      min-height: 0;
      background: #fff;
    }

    .fitText{
      width: 100%;
      line-height: 1.12;
      overflow-wrap: anywhere;
      word-break: break-word;
      white-space: pre-wrap;
    }

    /* Algebraic Expressions: keep exactly 2 lines (only break at our inserted newline) */
    .twoLineMath{
      white-space: pre;
      overflow-wrap: normal;
      word-break: normal;
    }

    /* Extra Credit must be single-line */
    .oneLineEC{
      white-space: nowrap !important;
      overflow-wrap: normal !important;
      word-break: normal !important;
    }

    .answerLine{
      display:none;
      border-top: 2px solid rgba(0,0,0,0.10);
      padding-top: 10px;
      margin-top: 4px;
      font-size: 22px;
      text-align:center;
      overflow-wrap:anywhere;
      word-break: break-word;
    }

    .oneLineAnswer{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      background: rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.15);
      border-bottom-width: 2px;
      padding: 2px 6px;
      border-radius: 8px;
    }

    /* ----- Split question area (TOP text, BOTTOM blank annotation space) ----- */
    .splitFit{
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
      align-items: stretch;
      justify-content: stretch;
    }
    .fitHalf{
      flex: 1 1 0;
      min-height: 0;
    }
    .fitTop{
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
    }
    /* Divider line: invisible (white on white) */
    .fitBottom{
      border-top: 2px solid #fff;
      background: #fff;
    }

    /* ----- Answer key overlay (black/white printable) ----- */
    #answerKeyOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
      z-index: 10000;
    }

    #answerKeySheet{
      width: min(900px, calc(100vw - 20px));
      max-height: calc(100vh - 20px);
      overflow: auto;
      background: #fff;
      color: #000;
      border: 3px solid #000;
      border-radius: 10px;
      padding: 14px;
      font-family: Arial, Helvetica, sans-serif;
    }

    .akHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .akTitle{
      font-size: 22px;
      font-weight: 700;
    }
    .akBtns button{
      font-size: 16px;
      padding: 8px 10px;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
      border-radius: 8px;
    }

    .akSectionTitle{
      font-size: 16px;
      font-weight: 700;
      margin: 10px 0 6px;
    }

    .akTable{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .akTable td, .akTable th{
      border: 1.8px solid #000;
      padding: 6px 6px;
      vertical-align: top;
      font-size: 13px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .akTable th{
      text-align: center;
      font-weight: 700;
    }

    @media (max-width: 520px){
      h1{ font-size: 34px; }
      .modalTitle{ font-size: 18px; }
      .modalBtn{ font-size: 18px; }
      .ptVal{ font-size: 36px; }
      .teamCard{ flex-basis: 200px; }
      #bottomFooter .restart{ font-size: 16px; }
      #bottomFooter .copy{ font-size: 14px; }
      .startBig{ font-size: 26px; }
      #answerKeyBtn{ font-size: 15px; }
    }

    /* Print: show only the answer key sheet */
    @media print{
      body *{ visibility: hidden !important; }
      #answerKeyOverlay, #answerKeyOverlay *{ visibility: visible !important; }
      #answerKeyOverlay{
        display: block !important;
        position: fixed !important;
        inset: 0 !important;
        background: #fff !important;
        padding: 0 !important;
      }
      #answerKeySheet{
        width: 100% !important;
        max-height: none !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0.4in !important;
      }
      .akBtns{ display: none !important; }
    }
  </style>
</head>

<body>
  <!-- hidden “sticky” copyright (so copy-paste of HTML keeps it around) -->
  <div class="hiddenCopyright">© True PBL. All Rights Reserved.</div>
  <div class="hiddenCopyright">© True PBL. All Rights Reserved.</div>

  <!-- SETUP PAGE -->
  <div id="setupPage" class="wrap">
    <h1>G7 Math Jeopardy Game</h1>

    <div class="panel">
      <div class="row">
        <label>Rows (≤ 5):
          <select id="rowsSel">
            <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
          </select>
        </label>

        <label>Columns (≤ 5):
          <select id="colsSel">
            <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
          </select>
        </label>

        <label>Teams:
          <input id="teamsNum" type="number" min="1" max="12" value="3" />
        </label>
      </div>
    </div>

    <div class="panel">
      <div class="sectionTitle">Topics (select up to 5)</div>
      <div id="topicsBox" class="checks"></div>
      <div id="topicWarn" class="warnLine">Please select up to 5 topics.</div>
    </div>

    <div class="panel">
      <div class="twoCol">
        <!-- Difficulty (LEFT) -->
        <div class="subPanel left">
          <div class="sectionTitle" style="margin-bottom:8px;">Difficulty</div>
          <div class="checks" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
            <label class="chip">
              <input type="radio" name="diffMode" id="modeE" value="E" checked />
              Easy
            </label>

            <label class="chip">
              <input type="radio" name="diffMode" id="modeEM" value="EM" />
              Easy, Medium
            </label>

            <label class="chip">
              <input type="radio" name="diffMode" id="modeEMH" value="EMH" />
              Easy, Medium, Hard
            </label>
          </div>
          <div id="diffHint" class="hintLine"></div>
        </div>

        <!-- Extra Credit + Start button (RIGHT) -->
        <div class="subPanel right">
          <div class="sectionTitle" style="margin-bottom:8px;">Show Extra Credit Problem</div>
          <div class="checks" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <label class="chip">
              <input type="radio" name="ecMode" id="ecNo" value="no" checked />
              No
            </label>
            <label class="chip">
              <input type="radio" name="ecMode" id="ecYes" value="yes" />
              Yes
            </label>
          </div>

          <button id="startBtn" class="startBig">Start Game</button>
        </div>
      </div>

      <!-- only ONCE on first page -->
      <div class="copyrightLine">© True PBL. All Rights Reserved.</div>
    </div>

    <!-- more hidden messages inside DOM + code -->
    <div class="hiddenCopyright">© True PBL. All Rights Reserved.</div>
    <!-- © True PBL. All Rights Reserved. -->
    <!-- © True PBL. All Rights Reserved. -->
  </div>

  <!-- GAME PAGE -->
  <div id="gamePage">
    <!-- © True PBL. All Rights Reserved. -->
    <div class="gameShell">
      <div id="board" class="board" aria-label="Jeopardy Board"></div>

      <!-- SCORE BAR (attached to bottom of this container) -->
      <div id="scoreBar">
        <div id="scoreBarInner">
          <div id="teamsRow"></div>
          <button id="answerKeyBtn" type="button">Answer Key to all questions</button>
        </div>
      </div>
    </div>

    <!-- bottom hint + copyright (one time for page 2) -->
    <div id="bottomFooter" aria-label="Footer">
      <div class="restart">To restart: refresh this page.</div>
      <div class="copy">© True PBL. All Rights Reserved.</div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <button class="modalBtn btnContinue" id="btnContinue">
          Continue <span class="kbd">ESC</span>
        </button>

        <div class="modalTitle" id="modalTitle"></div>

        <button class="modalBtn btnReveal" id="btnReveal">
          Reveal Answer <span class="kbd">Space</span>
        </button>
      </div>

      <div class="modalBody">
        <!-- Regular (2/3 height) -->
        <div class="qBox" id="regularBox" style="flex: 2 1 0;">
          <div class="qBoxHeader">
            <span>Question</span>
          </div>
          <div class="qBoxInner">
            <div class="fitArea splitFit" id="regularFit">
              <div class="fitHalf fitTop" id="regularFitTop">
                <div class="fitText" id="regularText"></div>
              </div>
              <div class="fitHalf fitBottom" id="regularFitBottom"></div>
            </div>
            <div class="answerLine" id="regularAns"></div>
          </div>
        </div>

        <!-- EC (1/3 height) -->
        <div class="qBox" id="ecBox" style="flex: 1 1 0; display:none;">
          <div class="qBoxHeader">
            <span>Extra Credit</span>
          </div>
          <div class="qBoxInner">
            <!-- NOTE: EC window is NOT split (no divider / no annotation box) -->
            <div class="fitArea" id="ecFit">
              <div class="fitText oneLineEC" id="ecText"></div>
            </div>
            <div class="answerLine oneLineAnswer" id="ecAns"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ANSWER KEY OVERLAY -->
  <div id="answerKeyOverlay" role="dialog" aria-modal="true">
    <div id="answerKeySheet">
      <div class="akHeader">
        <div class="akTitle">Answer Key</div>
        <div class="akBtns">
          <button type="button" id="akPrintBtn">Print</button>
          <button type="button" id="akCloseBtn">Close</button>
        </div>
      </div>

      <div class="akSectionTitle">Regular Question Answers (5 × 5)</div>
      <div id="akRegularWrap"></div>

      <div class="akSectionTitle" style="margin-top:14px;">Extra Credit Answers (5 × 5)</div>
      <div id="akEcWrap"></div>
    </div>
  </div>

<script>
/* © True PBL All Rights Reserved. */
/* © True PBL All Rights Reserved. */
/* © True PBL All Rights Reserved. */
(() => {
  // ---- COPYRIGHT (repeated inside JS so it follows copied code) ----
  const COPYRIGHT = "© True PBL. All Rights Reserved.";
  // © True PBL All Rights Reserved.
  // © True PBL All Rights Reserved.

  // ---- DATA SOURCE (corrected GitHub Pages link) ----
  const DATA_URL_PRIMARY = "https://daryeaye.github.io/xinlindywane/all_questions.json";
  // Fallback raw GitHub (helps if any embed/CORS weirdness)
  const DATA_URL_FALLBACK = "https://raw.githubusercontent.com/daryeaye/xinlindywane/main/all_questions.json";

  // Fruit order for duplicated columns ONLY (when < 5 topics selected AND repeats exist)
  const FRUITS = ["Apple","Banana","Cherry","Durian","Eggplant"];

  // Setup DOM
  const setupPage = document.getElementById("setupPage");
  const gamePage  = document.getElementById("gamePage");
  const boardEl   = document.getElementById("board");

  const topicsBox = document.getElementById("topicsBox");
  const topicWarn = document.getElementById("topicWarn");
  const startBtn  = document.getElementById("startBtn");

  const rowsSel   = document.getElementById("rowsSel");
  const colsSel   = document.getElementById("colsSel");
  const teamsNum  = document.getElementById("teamsNum");

  const modeE     = document.getElementById("modeE");
  const modeEM    = document.getElementById("modeEM");
  const modeEMH   = document.getElementById("modeEMH");
  const diffHint  = document.getElementById("diffHint");

  const ecNo      = document.getElementById("ecNo");
  const ecYes     = document.getElementById("ecYes");

  const scoreBarInner = document.getElementById("scoreBarInner");
  const teamsRow = document.getElementById("teamsRow");
  const answerKeyBtn = document.getElementById("answerKeyBtn");

  // Answer key overlay
  const answerKeyOverlay = document.getElementById("answerKeyOverlay");
  const akRegularWrap = document.getElementById("akRegularWrap");
  const akEcWrap = document.getElementById("akEcWrap");
  const akCloseBtn = document.getElementById("akCloseBtn");
  const akPrintBtn = document.getElementById("akPrintBtn");

  // Modal
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const btnContinue = document.getElementById("btnContinue");
  const btnReveal = document.getElementById("btnReveal");

  const regularFitTop = document.getElementById("regularFitTop");
  const regularText = document.getElementById("regularText");
  const regularAns = document.getElementById("regularAns");

  const ecBox = document.getElementById("ecBox");
  const ecFit = document.getElementById("ecFit");
  const ecText = document.getElementById("ecText");
  const ecAns = document.getElementById("ecAns");

  let ALL = [];
  let TOPICS = [];
  let EC_POOL = [];

  let game = {
    rows: 5,
    cols: 5,
    teams: 3,
    selectedTopics: [],
    diffMode: "E",     // "E" | "EM" | "EMH"
    extraCredit: false,
    columns: [],       // array of {topic, label}
    cells: {},         // cellId -> { q, a, ecQ, ecA }
    usedIds: new Set(),
    usedEcIds: new Set(),
    activeCellId: null
  };

  // ---------- helpers ----------
  function shuffle(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function toHtmlWithBreaks(s){
    if(!s) return "";
    return escapeHtml(s)
      .replace(/\\n/g, "<br/>")   // catches literal \n
      .replace(/\n/g, "<br/>");   // catches actual newline
  }

  function normalizeSingleLine(s){
    return (s ?? "").toString().replace(/\s+/g, " ").trim();
  }

  function isAlgebraicExpressionTopic(topic){
    const t = (topic || "").toLowerCase();
    return t.includes("algebraic") && t.includes("expression");
  }

  // Insert ONE line break so it displays as 2 lines for algebraic expression questions
  function forceTwoLinesExpression(text){
    const s = (text || "").toString();
    if(!s) return s;
    if(s.includes("\n")) return s;

    // Only touch "mathy" strings, not long sentences
    const hasSpaces = /\s/.test(s);
    const looksMathy = /[0-9a-zA-Z]/.test(s) && /[+\-=()^/*]/.test(s);
    if(hasSpaces && s.length > 40) return s;
    if(!looksMathy) return s;

    const mid = Math.floor(s.length / 2);
    const ops = ["=", "+", "-"];
    let best = -1;
    let bestDist = 1e9;

    for(let i = 0; i < s.length; i++){
      const ch = s[i];
      if(!ops.includes(ch)) continue;
      if(i === 0) continue; // avoid leading minus
      const dist = Math.abs(i - mid);
      if(dist < bestDist){
        bestDist = dist;
        best = i;
      }
    }

    if(best === -1) return s;

    const ch = s[best];
    if(ch === "="){
      return s.slice(0, best + 1) + "\n" + s.slice(best + 1);
    }
    return s.slice(0, best) + "\n" + s.slice(best);
  }

  async function fetchJson(){
    async function tryUrl(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error("bad response");
      return await r.json();
    }
    try{
      return await tryUrl(DATA_URL_PRIMARY);
    }catch(e){
      return await tryUrl(DATA_URL_FALLBACK);
    }
  }

  function buildTopicCheckboxes(){
    topicsBox.innerHTML = "";
    TOPICS.forEach(t => {
      const lab = document.createElement("label");
      lab.className = "chip";
      lab.innerHTML = `<input type="checkbox" value="${escapeHtml(t)}" /> ${escapeHtml(t)}`;
      topicsBox.appendChild(lab);
    });

    topicsBox.addEventListener("change", enforceTopicLimit);
    enforceTopicLimit();
  }

  function getSelectedTopics(){
    return Array.from(topicsBox.querySelectorAll("input[type='checkbox']:checked"))
      .map(x => x.value);
  }

  function enforceTopicLimit(){
    const inputs = Array.from(topicsBox.querySelectorAll("input[type='checkbox']"));
    const checked = inputs.filter(x => x.checked);
    const count = checked.length;

    if(count > 5){
      topicWarn.style.display = "block";
    } else {
      topicWarn.style.display = "none";
    }

    if(count >= 5){
      inputs.forEach(x => {
        if(!x.checked) x.disabled = true;
      });
    }else{
      inputs.forEach(x => x.disabled = false);
    }
  }

  function getDiffMode(){
    if(modeEMH.checked) return "EMH";
    if(modeEM.checked) return "EM";
    return "E";
  }

  function getExtraCreditMode(){
    return ecYes.checked ? true : false;
  }

  function bandForRow(rowIndex, rows, diffMode){
    if(diffMode === "E") return "easy";

    if(diffMode === "EM"){
      if(rows === 5) return (rowIndex <= 2) ? "easy" : "medium";
      if(rows === 4) return (rowIndex <= 1) ? "easy" : "medium";
      if(rows === 3) return (rowIndex <= 1) ? "easy" : "medium";
      if(rows === 2) return (rowIndex === 0) ? "easy" : "medium";
      return "easy";
    }

    // EMH
    if(rows === 5){
      if(rowIndex <= 1) return "easy";
      if(rowIndex <= 3) return "medium";
      return "hard";
    }
    if(rows === 4){
      if(rowIndex <= 1) return "easy";
      if(rowIndex === 2) return "medium";
      return "hard";
    }
    if(rows === 3){
      if(rowIndex === 0) return "easy";
      if(rowIndex === 1) return "medium";
      return "hard";
    }
    if(rows === 2){
      return (rowIndex === 0) ? "easy" : "medium";
    }
    return "easy";
  }

  function formatRange(minV, maxV){
    if(minV === maxV) return String(minV);
    return `${minV}–${maxV}`;
  }

  function diffHintText(rows, diffMode){
    const maxPts = rows * 100;

    if(diffMode === "E"){
      return `You chose: Easy. We will pull EASY problems for 100–${maxPts}.`;
    }

    if(diffMode === "EM"){
      const bands = [];
      for(let r=0;r<rows;r++){
        bands.push({ pts:(r+1)*100, band: bandForRow(r, rows, "EM") });
      }
      const easyPts = bands.filter(x=>x.band==="easy").map(x=>x.pts);
      const medPts  = bands.filter(x=>x.band==="medium").map(x=>x.pts);

      const easyRange = formatRange(Math.min(...easyPts), Math.max(...easyPts));
      const medRange  = formatRange(Math.min(...medPts),  Math.max(...medPts));

      return `You chose: Easy, Medium. We will pull EASY for ${easyRange} and MEDIUM for ${medRange}.`;
    }

    // EMH
    const bands = [];
    for(let r=0;r<rows;r++){
      bands.push({ pts:(r+1)*100, band: bandForRow(r, rows, "EMH") });
    }
    const easyPts = bands.filter(x=>x.band==="easy").map(x=>x.pts);
    const medPts  = bands.filter(x=>x.band==="medium").map(x=>x.pts);
    const hardPts = bands.filter(x=>x.band==="hard").map(x=>x.pts);

    const easyRange = formatRange(Math.min(...easyPts), Math.max(...easyPts));
    const medRange  = formatRange(Math.min(...medPts),  Math.max(...medPts));
    const hardRange = formatRange(Math.min(...hardPts), Math.max(...hardPts));

    return `You chose: Easy, Medium, Hard. We will pull EASY for ${easyRange}, MEDIUM for ${medRange}, and HARD for ${hardRange}.`;
  }

  /**
   * Columns + labels:
   * - If user selects exactly 5 topics: NEVER add fruits.
   * - If user selects < 5 topics:
   *   - If a topic does NOT repeat in the final columns => label is plain topic
   *   - If a topic repeats => ALL occurrences are fruit-labeled:
   *       Topic Apple, Topic Banana, Topic Cherry, Topic Durian, Topic Eggplant...
   *
   * NEW: If user selects < cols topics, distribute repeats as evenly as possible.
   * Example: 2 topics and 5 columns -> 3 + 2 (not 4 + 1).
   */
  function buildColumns(selectedTopics, cols){
    // Safety
    if(selectedTopics.length > 5){
      selectedTopics = selectedTopics.slice(0, 5);
    }

    const n = selectedTopics.length;

    // Choose topics for columns (fill if needed)
    let topicsForCols = [];

    if(n >= cols){
      topicsForCols = selectedTopics.slice(0, cols);
    } else {
      // Even distribution
      const order = selectedTopics.slice();
      shuffle(order); // randomly decides who gets the extra column(s)

      const base = Math.floor(cols / n);
      const rem  = cols % n;

      for(let i=0;i<n;i++){
        const count = base + (i < rem ? 1 : 0);
        for(let k=0;k<count;k++){
          topicsForCols.push(order[i]);
        }
      }
      topicsForCols = topicsForCols.slice(0, cols);
    }

    // Exactly 5 chosen => no fruits at all.
    if(selectedTopics.length === 5){
      return topicsForCols.map(topic => ({ topic, label: topic }));
    }

    // Count occurrences in final columns
    const counts = {};
    for(const t of topicsForCols){
      counts[t] = (counts[t] || 0) + 1;
    }

    // For repeated topics, label ALL occurrences with fruit order
    const repeatIndex = {};
    return topicsForCols.map(topic => {
      if((counts[topic] || 0) <= 1){
        return { topic, label: topic };
      }
      repeatIndex[topic] = (repeatIndex[topic] || 0);
      const fruit = FRUITS[Math.min(repeatIndex[topic], FRUITS.length - 1)];
      repeatIndex[topic] += 1;
      return { topic, label: `${topic} ${fruit}` };
    });
  }

  function buildPools(){
    const pools = {};
    TOPICS.forEach(t => {
      pools[t] = { easy: [], medium: [], hard: [] };
    });

    EC_POOL = ALL.filter(x => x.isExtraCredit || (x.topic || "").toLowerCase() === "extra credit");

    ALL.forEach(item => {
      const t = item.topic;
      const b = (item.difficultyBand || "").toLowerCase();
      if(pools[t] && pools[t][b]){
        pools[t][b].push(item);
      }
    });

    TOPICS.forEach(t => {
      shuffle(pools[t].easy);
      shuffle(pools[t].medium);
      shuffle(pools[t].hard);
    });
    shuffle(EC_POOL);

    return pools;
  }

  function pickQuestion(pools, topic, band){
    const order = [band, "easy", "medium", "hard"].filter((v, i, a) => a.indexOf(v) === i);
    for(const b of order){
      const arr = pools[topic]?.[b] || [];
      while(arr.length){
        const q = arr.pop();
        if(!game.usedIds.has(q.id)){
          game.usedIds.add(q.id);
          return q;
        }
      }
    }
    // fallback: any unused
    const allBands = ["easy","medium","hard"];
    for(const b of allBands){
      const arr = pools[topic]?.[b] || [];
      while(arr.length){
        const q = arr.pop();
        if(!game.usedIds.has(q.id)){
          game.usedIds.add(q.id);
          return q;
        }
      }
    }
    return null;
  }

  function pickExtraCredit(){
    if(EC_POOL.length === 0) return null;
    for(let tries=0; tries<EC_POOL.length; tries++){
      const q = EC_POOL.shift();
      EC_POOL.push(q);
      if(!game.usedEcIds.has(q.id)){
        game.usedEcIds.add(q.id);
        return q;
      }
    }
    return EC_POOL[0] || null;
  }

  function buildBoard(){
    boardEl.innerHTML = "";
    const cols = game.cols;
    const rows = game.rows;

    boardEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    // Category header.
    game.columns.forEach((c) => {
      const d = document.createElement("div");
      d.className = "cell catCell";
      d.innerHTML = escapeHtml(c.label);
      boardEl.appendChild(d);
    });

    // Point cells
    for(let r=0; r<rows; r++){
      const points = (r + 1) * 100;
      for(let c=0; c<cols; c++){
        const cellId = `r${r}c${c}`;
        const div = document.createElement("div");
        div.className = "cell ptCell";
        div.setAttribute("data-cell", cellId);

        const inner = document.createElement("div");
        inner.className = "ptVal";
        inner.textContent = String(points);
        div.appendChild(inner);

        div.addEventListener("click", () => {
          if(div.classList.contains("inert")) return;
          openCell(cellId);
        });

        boardEl.appendChild(div);
      }
    }
  }

  function buildScoreBar(){
    teamsRow.innerHTML = "";
    const n = Math.max(1, Math.min(12, parseInt(game.teams, 10) || 3));

    // Center if 1–2 teams
    teamsRow.style.justifyContent = (n <= 2) ? "center" : "flex-start";

    for(let i=0;i<n;i++){
      const card = document.createElement("div");
      card.className = "teamCard";
      card.innerHTML = `
        <div class="teamTop">
          <div class="teamName" contenteditable="true">Team ${i+1}</div>
          <div class="teamPts" contenteditable="true">0</div>
        </div>
        <div class="teamBtns">
          <button class="miniBtn gain" type="button">Gain</button>
          <button class="miniBtn loss" type="button">Loss</button>
        </div>
      `;
      const gainBtn = card.querySelector(".gain");
      const lossBtn = card.querySelector(".loss");
      const ptsEl = card.querySelector(".teamPts");

      function adjust(mult){
        const active = game.activeCellId;
        if(!active) return;
        const cell = game.cells[active];
        if(!cell) return;
        const p = parseInt((cell.points || "0"), 10) || 0;
        const cur = parseInt((ptsEl.textContent || "0").trim(), 10);
        const curSafe = isNaN(cur) ? 0 : cur;
        ptsEl.textContent = String(curSafe + (p * mult));
      }

      gainBtn.addEventListener("click", () => adjust(+1));
      lossBtn.addEventListener("click", () => adjust(-1));

      teamsRow.appendChild(card);
    }
  }

  function assignQuestions(){
    const pools = buildPools();
    game.cells = {};
    game.usedIds = new Set();
    game.usedEcIds = new Set();

    for(let r=0; r<game.rows; r++){
      for(let c=0; c<game.cols; c++){
        const cellId = `r${r}c${c}`;
        const points = (r + 1) * 100;

        const topic = game.columns[c].topic;
        const band = bandForRow(r, game.rows, game.diffMode);

        const qObj = pickQuestion(pools, topic, band);

        let ecObj = null;
        if(game.extraCredit){
          ecObj = pickExtraCredit();
        }

        game.cells[cellId] = {
          points,
          topic,
          band,
          q: qObj ? qObj.question : "(No question found)",
          a: qObj ? qObj.answer : "",
          ecQ: (ecObj ? ecObj.question : ""),
          ecA: (ecObj ? ecObj.answer : ""),
          inert: false
        };
      }
    }
  }

  // Auto-fit text to a box
  function fitTextToBox(fitAreaEl, textEl, maxPx=120, minPx=18){
    if(!fitAreaEl || !textEl) return;
    const w = fitAreaEl.clientWidth - 10;
    const h = fitAreaEl.clientHeight - 10;
    if(w <= 0 || h <= 0) return;

    let size = maxPx;
    textEl.style.fontSize = size + "px";

    let guard = 220;
    while(guard-- > 0){
      const tooTall = textEl.scrollHeight > fitAreaEl.clientHeight;
      const tooWide = textEl.scrollWidth > fitAreaEl.clientWidth;
      if(!tooTall && !tooWide) break;
      size -= 2;
      if(size <= minPx){ size = minPx; break; }
      textEl.style.fontSize = size + "px";
    }
  }

  function refreshModalFit(){
    // Regular: fit inside TOP half only
    fitTextToBox(regularFitTop, regularText, 128, 18);

    // EC: fit inside its own (non-split) fitArea
    if(ecBox.style.display !== "none"){
      fitTextToBox(ecFit, ecText, 72, 12);
    }
  }

  function openCell(cellId){
    const cell = game.cells[cellId];
    if(!cell) return;

    game.activeCellId = cellId;

    // Determine column label by col index
    const m = cellId.match(/c(\d+)/);
    const colIndex = m ? parseInt(m[1], 10) : 0;
    const colLabel = game.columns[colIndex]?.label || `${cell.topic}`;
    modalTitle.textContent = `${colLabel} — ${cell.points}`;

    // Regular question text (special 2-line rule for Algebraic Expressions)
    let qText = (cell.q || "");
    const isAlg = isAlgebraicExpressionTopic(cell.topic);

    regularText.classList.toggle("twoLineMath", isAlg);

    if(isAlg){
      qText = forceTwoLinesExpression(qText);
    }
    regularText.innerHTML = toHtmlWithBreaks(qText);

    // Answers hidden until Space/Reveal
    regularAns.style.display = "none";
    regularAns.textContent = cell.a ? `Answer: ${cell.a}` : "";

    // EC section (single line ALWAYS).
    if(game.extraCredit){
      ecBox.style.display = "";
      const ecQ = normalizeSingleLine(cell.ecQ || "");
      ecText.innerHTML = escapeHtml(ecQ);

      ecAns.style.display = "none";
      ecAns.textContent = cell.ecA ? `Answer: ${normalizeSingleLine(cell.ecA)}` : "";
    }else{
      ecBox.style.display = "none";
    }

    modalOverlay.style.display = "flex";
    requestAnimationFrame(() => refreshModalFit());
  }

  function revealAnswer(){
    const id = game.activeCellId;
    if(!id) return;
    const cell = game.cells[id];
    if(!cell) return;

    if(regularAns.textContent.trim() !== ""){
      regularAns.style.display = "block";
    }
    if(game.extraCredit && ecBox.style.display !== "none" && ecAns.textContent.trim() !== ""){
      ecAns.style.display = "block";
    }

    // Mark cell inert after reveal.
    cell.inert = true;
    const domCell = boardEl.querySelector(`.ptCell[data-cell="${id}"]`);
    if(domCell) domCell.classList.add("inert");

    requestAnimationFrame(() => refreshModalFit());
  }

  function closeModal(){
    modalOverlay.style.display = "none";
    // keep game.activeCellId so Gain/Loss still works after exiting the problem
  }

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if(modalOverlay.style.display === "flex"){
      if(e.key === "Escape"){
        e.preventDefault();
        closeModal();
      }else if(e.code === "Space"){
        e.preventDefault();
        revealAnswer();
      }
    }
    if(answerKeyOverlay.style.display === "flex" && e.key === "Escape"){
      e.preventDefault();
      closeAnswerKey();
    }
  });

  btnContinue.addEventListener("click", closeModal);
  btnReveal.addEventListener("click", revealAnswer);
  modalOverlay.addEventListener("click", (e) => {
    if(e.target === modalOverlay) closeModal();
  });

  window.addEventListener("resize", () => {
    if(modalOverlay.style.display === "flex"){
      refreshModalFit();
    }
  });

  function updateDiffHint(){
    const rows = parseInt(rowsSel.value, 10) || 5;
    diffHint.textContent = diffHintText(Math.min(5, Math.max(1, rows)), getDiffMode());
  }

  /* ---------- Answer Key ---------- */

  // Column headers: use the same column labels as the board (Topic / Topic Apple etc.)
  function getAnswerKeyHeaders(){
    const headers = [];
    for(let c=0;c<5;c++){
      headers.push((c < game.cols) ? (game.columns[c]?.label || "") : "");
    }
    return headers;
  }

  // 5x5 answers, with TOP header row = topic labels; NO left-side row numbers
  function make5x5AnswerTable(headers, getValueFn){
    const table = document.createElement("table");
    table.className = "akTable";

    // Header row
    const thead = document.createElement("thead");
    const hr = document.createElement("tr");
    for(let c=0;c<5;c++){
      const th = document.createElement("th");
      th.textContent = headers[c] || "";
      hr.appendChild(th);
    }
    thead.appendChild(hr);
    table.appendChild(thead);

    // Body 5 rows
    const tbody = document.createElement("tbody");
    for(let r=0;r<5;r++){
      const tr = document.createElement("tr");
      for(let c=0;c<5;c++){
        const td = document.createElement("td");
        td.textContent = getValueFn(r, c) || "";
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);

    return table;
  }

  function openAnswerKey(){
    const headers = getAnswerKeyHeaders();

    // Regular answers 5x5 (blank if outside chosen rows/cols)
    akRegularWrap.innerHTML = "";
    akRegularWrap.appendChild(
      make5x5AnswerTable(headers, (r,c) => {
        if(r >= game.rows || c >= game.cols) return "";
        const cell = game.cells[`r${r}c${c}`];
        return cell?.a ? String(cell.a) : "";
      })
    );

    // EC answers 5x5 (blank if extra credit off / outside rows/cols)
    akEcWrap.innerHTML = "";
    akEcWrap.appendChild(
      make5x5AnswerTable(headers, (r,c) => {
        if(!game.extraCredit) return "";
        if(r >= game.rows || c >= game.cols) return "";
        const cell = game.cells[`r${r}c${c}`];
        return cell?.ecA ? String(cell.ecA) : "";
      })
    );

    answerKeyOverlay.style.display = "flex";
  }

  function closeAnswerKey(){
    answerKeyOverlay.style.display = "none";
  }

  answerKeyBtn.addEventListener("click", openAnswerKey);
  akCloseBtn.addEventListener("click", closeAnswerKey);
  akPrintBtn.addEventListener("click", () => window.print());
  answerKeyOverlay.addEventListener("click", (e) => {
    if(e.target === answerKeyOverlay) closeAnswerKey();
  });

  // ---------- start ----------
  async function init(){
    ALL = await fetchJson();

    // Build topic list excluding extra credit
    const set = new Set(
      ALL
        .filter(x => !(x.isExtraCredit || (x.topic || "").toLowerCase() === "extra credit"))
        .map(x => x.topic)
        .filter(Boolean)
    );
    TOPICS = Array.from(set).sort((a,b) => a.localeCompare(b));
    buildTopicCheckboxes();
    updateDiffHint();
  }

  // Update hint when user changes rows or difficulty mode
  rowsSel.addEventListener("change", updateDiffHint);
  modeE.addEventListener("change", updateDiffHint);
  modeEM.addEventListener("change", updateDiffHint);
  modeEMH.addEventListener("change", updateDiffHint);

  startBtn.addEventListener("click", () => {
    const rows = parseInt(rowsSel.value, 10) || 5;
    const cols = parseInt(colsSel.value, 10) || 5;
    const teams = parseInt(teamsNum.value, 10) || 3;

    const topics = getSelectedTopics();

    if(topics.length === 0){
      alert("Please select at least 1 topic.");
      return;
    }
    if(topics.length > 5){
      topicWarn.style.display = "block";
      alert("Please select up to 5 topics.");
      return;
    }

    game.rows = Math.min(5, Math.max(1, rows));
    game.cols = Math.min(5, Math.max(1, cols));
    game.teams = Math.min(12, Math.max(1, teams));
    game.selectedTopics = topics;
    game.diffMode = getDiffMode();
    game.extraCredit = getExtraCreditMode();

    game.columns = buildColumns(game.selectedTopics, game.cols);

    assignQuestions();
    buildBoard();
    buildScoreBar();

    // Switch pages
    document.body.style.background = "var(--jeopardy-blue)";
    setupPage.style.display = "none";
    gamePage.style.display = "block";
  });

  init().catch(() => {
    alert("I couldn't load the question bank. Please check your JSON link.");
  });
})();
</script>
</body>
</html>
